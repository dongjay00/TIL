# Cookies? Sessions? Token?

> Auth(인증)을 통해 서비스는 유저를 검증할 수 있습니다.
>
> Auth를 사용하려 했다면, 쿠키, 세션, 토큰 같은 단어를 많이 들어봤을 것입니다.
>
> 단어들 각각의 의미가 무엇이고, 어떻게 연결되고, 언제 무엇을 써야 하는지 정리해보겠습니다.



## 쿠키(Cookies)

> 쿠키를 이용해서, 서버는 브라우저에 데이터를 저장할 수 있다. 이는 유저를 기억하기 위해서이다.
>
> 즉, 쿠키는 **매개체** 역할 담당이다.

- 사이트를 방문하면, 브라우저는 서버에 요청을 보낸다.
- 서버는 응답으로 모든 데이터, 유저가 찾던 페이지 정보를 보낸다.
  - 여기에 쿠키를 같이 보낼 수 있다.
- 브라우저에 쿠키를 저장한 후,  해당 웹사이트에 방문할 때마다 브라우저는 해당 쿠키도 요청과 함께 보내게 된다.
  - 쿠키는 도메인에 따라 제한이 있다. 예를 들어, 네이버가 준 쿠키는 네이버에만 보내진다.
  - 쿠키는 유효기간이 있다. 유효기간은 서버가 결정한다.
- 쿠키는 인증 뿐만 아니라, 여러 정보를 저장할 수 있다.
  - 가령 웹사이트 언어설정 정보를 기억해서 서버에 보내면, 서버는 쿠키가 기억해둔 언어설정의 페이지를 제공한다.



## 세션(Sessions)

> 왜 세션과 토큰이 필요한지 이해하려면, HTTP를 이해해야 한다.
>
> HTTP는 기본적으로 stateless이다. 서버로 가는 모든 요청이 이전 요청과 독립적으로 다뤄진다는 뜻이다.
>
> 요청끼리 연결이 없다. 즉, 메모리가 없다. 요청이 끝나면 서버는 유저가 누군지 잊어버린다(기억하지 않는다).
>
> 즉, 요청을 할 때마다 유저가 누군지 알려줘야 한다. 이를 하는 방법 중 하나가 바로 **세션(Sessions)**이다.

- 로그인을 하고 싶다면, 유저명과 비밀번호를 서버에 보낼 것이다.
- 비밀번호가 맞다면, 서버는 세션 DB에 유저를 생성한다. 해당 세션에는 별도의 ID가 존재한다.
- 해당 세션 ID는 쿠키를 통해 브라우저로 돌아오고 저장된다.
  - 따라서, 같은 웹사이트의 다른 페이지로 이동하면, 브라우저는 세션 ID를 갖고있는 쿠키를 서버에 보낸다.
  - 쿠키는 자동으로 보내지므로, 서버는 들어오는 쿠키를 보고 세션 ID와 함께 오는 쿠키를 확인한다. 물론, 이 단계 까지 서버는 유저가 누구인지 알 수 없다. **세션 ID가 있는 쿠키를 지닌 요청이 있다는 것만 알 뿐이다.**
  - 해당 세션 ID로 세션 DB를 뒤져서, 비로소 유저명을 알게 된다. **이 단계에서 서버는 유저가 누구인지 알게 된다.**
- 해당 요청이 끝나고, 다른 페이지로 이동하면 이 프로세스가 계속 반복될 것이다.
- 중요한 유저 정보는 모두 서버에 있고, 브라우저가 가지고 있는 것은 세션 ID 뿐이다. 쿠키는 그저 세션 ID를 전달하기 위한 **매개체**일 뿐이다.
  - 세션을 이용해 ios나 안드로이드 네이티브 앱을 만들 수는 있지만, 쿠키는 사용할 수 없다. **쿠키는 브라우저 전용이다.**
  - 바로 위와 같은 상황에서 사용하게 되는 것이 토큰(token)이다.



## 토큰(Token)

> 서버가 기억하는 이상하게 생긴 **string 타입의 ID 카드**
>
> 쿠키 대신 서버에 토큰을 보내자

- 토큰은 string 타입이다.
- 해당 토큰을 서버로 보내고, 서버는 세션 DB에서 해당 토큰과 일치하는 유저를 찾는다.
- 세션은 현재 로그인한 유저들의 모든 세션 ID를 DB에 저장해야 한다.
  - 즉, 요청이 들어올 때마다 서버는 쿠키를 받아서 세션 ID를 보고, ID와 일치하는 유저를 찾은 후에야 다음 작업을 수행할 수 있다. **요청이 있을 때마다 DB를 찾는 작업이 필수인 것이다.**
  - 당연히 유저가 늘어남에 따라, DB 자원이 더 필요하게 된다.
- 바로 이때, JWT라는 토큰 형식이 등장한다.



## JWT

> DB 없이 검증할 수 있도록, **정보를 가지고 있는 토큰**
>
> JWT로 유저 인증을 처리하면, 세션 DB를 가질 필요가 없고, 서버는 유저 인증한다고 많은 일을 하지 않아도 된다.

- **핵심은 토큰을 사인하고, 이를 통해 사인된 토큰이 유효한지 검증하는 것이다.** 예를 들어 이해해보자.
- **JWT vs. 세션**
  - 로그인 예시로 설명한다.
  - 유저가 로그인을 하려면, 유저명과 비밀번호를 서버에 보내야 한다. (여기까지는 동일)
    - 유저명과 비밀번호가 맞다면, 서버는 DB에 뭔가를 생성하지 않는다. 
    - 대신, 서버는 유저의 ID를 가져다가 **사인 알고리즘을 이용해서 '사인'을 한다.**
    - 이 `사인된 정보`를 string 형태로 유저에게 보낸다.
  - 즉, 동일한 로그인 과정임에도 DB를 건드리는 대신, 정보를 사인하고 전달하는 게 다이다.
  - JWT는 세션 ID에 비해 아주 길이가 길다.
    - 쿠키의 경우엔 공간 제약이 있는 반면, JWT는 제약이 없어서 엄청 길어도 상관없음.
  - 서버에 요청을 보내려면, 세션 ID와 비슷하게 해당 `사인된 정보` 혹은 `토큰` 을 서버에 보내야 한다.
    - 서버는 토큰을 받으면, 해당 사인이 유효한지 체크한다. 유효하다면, 서버는 유저를 인증하게 된다.
    - 바로 이 점이 세션과 JWT의 가장 큰 차이점이다.



다시 한 번 정리해보면

- 세션은 세션 ID만 주면 되고, 모든 정보를 세션 DB에 저장하고 있다. 서버는 세션 ID를 DB에서 찾으면 된다.
- JWT에선 서버는 유저를 인증하는데 필요한 정보를 토큰에 저장한다. 그 토큰을 유저에게 제공하고, 유저가 요청할 때 서버는 해당 토큰이 유효한지만 검증하면 된다. **DB를 거칠 필요가 없다.**



- 참고로 JWT는 암호화된 상태가 아니다(암호화가 되었다면 아무도 읽을 수 없고, 이해할 수도 없었겠지...). 즉, 누구나 열어서 해당 컨텐츠를 볼 수 있다. **그러므로 비밀 정보는 절대 JWT 안에 둬선 안된다.**



## 세션과 JWT 장단점

- **세션의 장점**
  - 서버가 로그인 된 유저의 모든 정보를 세션 DB에 저장한다는 특성을 이용해, 새로운 기능들을 추가할 수 있다.
    - 유저를 쫓아내고 싶을 때, 그냥 세션을 삭제해버리면 된다.
    - 로그인된 모든 디바이스를 보여주고, 원치 않는 디바이스에서 강제 로그아웃을 할 수 있다.
    - 계정 공유 숫자를 제한할 수도 있다. 현재 로그인을 몇 명이 했고, 시청하는지 알 수 있기 때문.

- **세션의 단점**
  - 세션 DB를 사고 유지하는데 비용이 든다.
    - 유저가 늘어날 수록 DB도 커져야 한다. 
    - 이를 위한 DB로 주로 `Redis`를 사용한다. 해당 목적을 수행하기 위한 빠르고, 저렴한 DB이기 때문.



- **JWT의 장점**
  - DB를 따로 살 필요가 없다.
    - JWT를 사용하면, 생성된 토큰을 추적하지 않는다. 서버가 아는 정보라곤, 해당 토큰이 유효한가 여부일 뿐.
    - 단지 데이터를 사인하고, 유저에게 보내고, 해당 데이터를 돌려받을 때 유효성을 검증할 수 있다.
    - ex) 코로나 QR 체크인은 JWT가 들어간 QR 코드를 활용한 것이다.
- **JWT의 단점**
  - 세션의 장점으로 말한 기능들을 할 순 없다.
    - 해당 토큰이 만료되기 전까진 유효하므로, 강제 로그아웃 같은 기능은 불가함 



JWT를 사용하면 매우 간편하다. 하지만 서비스가 더 커지고 유저 계정을 좀 더 잘 관리하고 싶다면, 그 땐 세션 도입을 고려하면 된다.